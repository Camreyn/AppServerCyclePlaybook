---
# =============================================================================
# was_stop_discovered.yml
# Stop discovered WAS application servers on limited tier hosts
#
# This playbook:
#   1. Runs pre-flight checks (su-to-wsadmin, DMGR SOAP, script staging)
#   2. Discovers application servers for nodes in scope
#   3. Stops each discovered application server via wsadmin
#   4. Optionally stops the nodeagent on each host
#
# Required variables:
#   - was_dmgr_host: DMGR hostname (delegate target)
#   - was_dmgr_profile: Path to DMGR profile (e.g., /opt/WebSphere/AppServer/profiles/Dmgr01)
#   - was_wsadmin_user: wsadmin SOAP authentication user
#   - was_wsadmin_pass: wsadmin SOAP authentication password
#   - was_node_profile_path: Per-host path to node profile
#   - was_node_name: Per-host WebSphere node name
#   - was_allow_disruptive: Must be true to proceed (safety gate)
#
# Optional variables:
#   - was_run_user: OS user to run wsadmin as (default: wsadmin)
#   - was_dmgr_soap_port: DMGR SOAP port (default: 8879)
#   - was_dmgr_soap_wait_timeout_sec: Timeout waiting for SOAP port (default: 300)
#   - was_poll_timeout_sec: Timeout for server stop operation (default: 600)
#   - was_poll_delay_sec: Delay between state checks (default: 5)
#   - was_stop_nodeagent: Whether to stop nodeagent after servers (default: true)
# =============================================================================

- name: Stop discovered WAS application servers on limited tier hosts
  hosts: was_all_nodes
  gather_facts: false
  serial: 1

  # Privilege escalation: deploy â†’ root (via su), then tasks use su - wsadmin -c
  become: true
  become_user: root
  become_method: su

  vars:
    # OS user that should run wsadmin.sh
    was_run_user: "wsadmin"

    # Wrapper: run a command as wsadmin (no Ansible become required)
    was_su_wsadmin_prefix: "/bin/su - {{ was_run_user }} -c"

    # Where we stage Jython scripts on the DMGR host (no root required)
    was_wsadmin_stage_dir: "/tmp/was_wsadmin_scripts"

    # DMGR SOAP configuration
    was_dmgr_soap_port: "8879"
    was_dmgr_soap_wait_timeout_sec: "300"

    # Server control timeouts
    was_poll_timeout_sec: "600"
    was_poll_delay_sec: "5"

    # Optional behavior toggles
    was_stop_nodeagent: "true"

  tasks:
    # ==========================================================================
    # Pre-flight: Safety, validation, su-wsadmin test, SOAP check, discovery
    # ==========================================================================
    - name: Include shared pre-flight tasks
      ansible.builtin.include_tasks:
        file: was_preflight_common.yml

    # ==========================================================================
    # Stop discovered application servers (one at a time)
    # ==========================================================================
    - name: Stop discovered application servers (one at a time; run as wsadmin)
      ansible.builtin.shell: >
        set -euo pipefail &&
        {{ was_su_wsadmin_prefix }} "cd '{{ was_dmgr_profile }}/bin' &&
        ./wsadmin.sh -quiet -lang jython
        -conntype SOAP -host 127.0.0.1 -port '{{ was_dmgr_soap_port }}'
        -user '{{ was_wsadmin_user }}' -password '{{ was_wsadmin_pass }}'
        -f '{{ was_wsadmin_stage_dir }}/control_server.py'
        --action stop
        --node '{{ item.node }}'
        --server '{{ item.server }}'
        --timeout '{{ was_poll_timeout_sec }}'
        --delay '{{ was_poll_delay_sec }}'"
      args:
        executable: /bin/bash
      register: stop_out
      delegate_to: "{{ was_dmgr_host }}"
      loop: "{{ was_discovered_targets }}"
      loop_control:
        label: "{{ item.node }}/{{ item.server }}"
      run_once: true
      changed_when: (stop_out.stdout | default('')) is search('CHANGED:true')
      failed_when: stop_out.rc != 0
      become: true

    - name: Show stop results
      ansible.builtin.debug:
        msg: "{{ stop_out.results | map(attribute='stdout_lines') | list }}"
      run_once: true
      become: false

    # ==========================================================================
    # Stop nodeagent on each host (optional, common before reboot)
    # ==========================================================================
    - name: Stop nodeagent on this host (optional; run as wsadmin)
      when: was_stop_nodeagent | bool
      ansible.builtin.shell: >
        set -euo pipefail &&
        {{ was_su_wsadmin_prefix }} "{{ was_node_profile_path }}/bin/stopNode.sh
        -username '{{ was_wsadmin_user }}'
        -password '{{ was_wsadmin_pass }}'"
      args:
        executable: /bin/bash
      register: nodeagent_stop
      changed_when: nodeagent_stop.rc == 0
      failed_when: >
        nodeagent_stop.rc != 0 and
        ("ADMU0116I" not in (nodeagent_stop.stdout | default(''))) and
        ("already stopped" not in (nodeagent_stop.stdout | default('') | lower)) and
        ("not running" not in (nodeagent_stop.stdout | default('') | lower))
      become: true

    - name: Show nodeagent stop result
      when: was_stop_nodeagent | bool
      ansible.builtin.debug:
        msg: "Nodeagent stop on {{ inventory_hostname }}: rc={{ nodeagent_stop.rc }}"
      become: false
